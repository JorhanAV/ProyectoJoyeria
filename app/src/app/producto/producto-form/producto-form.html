<div class="form-container">
  <h2>
    {{ esEdicion ? ('PRODUCTO_TEXT.EDITAR_PRODUCTO' | translate) : ('PRODUCTO_TEXT.CREAR_PRODUCTO' | translate) }}
  </h2>

  <form [formGroup]="productoForm" (ngSubmit)="submitProducto()">
    <!-- Nombre -->
    <label>{{ 'PRODUCTO_TEXT.NOMBRE' | translate }}</label>
    <input
      type="text"
      formControlName="nombre"
      [class.invalid]="productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched"
    />
    <div
      class="error-msg"
      *ngIf="productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched"
    >
      {{ 'PRODUCTO_TEXT.CAMPO_OBLIGATORIO' | translate }}
    </div>

    <!-- Descripción -->
    <label>{{ 'PRODUCTO_TEXT.DESCRIPCION_DETALLADA' | translate }}</label>
    <textarea
      formControlName="descripcion"
      [class.invalid]="productoForm.get('descripcion')?.invalid && productoForm.get('descripcion')?.touched"
    ></textarea>
    <div
      class="error-msg"
      *ngIf="productoForm.get('descripcion')?.invalid && productoForm.get('descripcion')?.touched"
    >
      {{ 'PRODUCTO_TEXT.CAMPO_OBLIGATORIO' | translate }}
    </div>

    <!-- Precio -->
    <label>{{ 'PRODUCTO_TEXT.PRECIO_BASE' | translate }}</label>
    <input
      type="number"
      formControlName="precio_base"
      [class.invalid]="productoForm.get('precio_base')?.invalid && productoForm.get('precio_base')?.touched"
    />
    <div
      class="error-msg"
      *ngIf="productoForm.get('precio_base')?.errors?.['min']"
    >
      {{ 'PRODUCTO_TEXT.PRECIO_DEBE_SER_MAYOR_A_0' | translate }}
    </div>

    <!-- Imágenes del producto -->
    <label>{{ 'PRODUCTO_TEXT.IMAGENES' | translate }}</label>

    <!-- Imágenes existentes (solo en edición) -->
    <div class="galeria-actual" *ngIf="esEdicion && imagenesActuales.length">
      <div class="img-card" *ngFor="let img of imagenesActuales">
        <img
          [src]="'http://localhost:3000/imagenes/' + img"
          alt="img existente"
        />
        <button
          type="button"
          class="btn-eliminar"
          (click)="eliminarImagenActual(img)"
        >
          ❌
        </button>
      </div>
    </div>

    <!-- Nuevas imágenes seleccionadas -->
    <input type="file" multiple (change)="selectFiles($event)" #fileUpload />
    <div class="preview-imagenes" *ngIf="previews.length">
      <div class="img-card" *ngFor="let img of previews; let i = index">
        <img [src]="img" alt="preview nueva" />
        <button type="button" (click)="eliminarPreview(i)" class="btn-eliminar">
          ❌
        </button>
      </div>
    </div>

    <!-- Categoría -->
    <label>{{ 'PRODUCTO_TEXT.CATEGORIA' | translate }}</label>
    <select
      formControlName="categoria_id"
      [class.invalid]="productoForm.get('categoria_id')?.invalid && productoForm.get('categoria_id')?.touched"
    >
      <option value="">{{ 'PRODUCTO_TEXT.SELECCIONAR_CATEGORIA' | translate }}</option>
      <option *ngFor="let cat of categorias" [value]="cat.id">
        {{ cat.nombre }}
      </option>
    </select>
    <div
      class="error-msg"
      *ngIf="productoForm.get('categoria_id')?.errors?.['required']"
    >
      {{ 'PRODUCTO_TEXT.CAMPO_OBLIGATORIO' | translate }}
    </div>

    <!-- Etiquetas -->
    <label>{{ 'PRODUCTO_TEXT.ETIQUETAS' | translate }}</label>
    <div class="checkbox-group">
      <label *ngFor="let etiqueta of etiquetas">
        <input
          type="checkbox"
          [value]="etiqueta.id"
          (change)="toggleEtiqueta(etiqueta.id, $event)"
          [checked]="etiquetasSeleccionadas.includes(etiqueta.id)"
        />
        {{ etiqueta.nombre }}
      </label>
    </div>

    <label>{{ 'PRODUCTO_TEXT.STOCK_DISPONIBLE' | translate }}</label>
    <input
      type="number"
      formControlName="stock"
      [class.invalid]="productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched"
    />
    <div class="error-msg" *ngIf="productoForm.get('stock')?.errors?.['min']">
      {{ 'PRODUCTO_TEXT.STOCK_DEBE_SER_MAYOR_O_IGUAL_A_0' | translate }}
    </div>

    <label>¿{{ 'PRODUCTO_TEXT.PRODUCTO_ACTIVO' | translate }}?</label>
    <input type="checkbox" formControlName="activo" />

    <!-- Promedio (solo lectura) -->
    <label>{{ 'PRODUCTO_TEXT.PROMEDIO_VALORACIONES' | translate }}</label>
    <div class="valoracion-display">
      <ng-container *ngFor="let estrella of [1,2,3,4,5]">
        <span
          class="estrella"
          [ngClass]="{ activa: estrella <= promedioValoracion }"
          >★</span
        >
      </ng-container>
      <span class="valor-num">({{ promedioValoracion.toFixed(1) }})</span>
    </div>

    <!-- Botón de acción -->
    <button type="submit">
      {{ esEdicion ? ('PRODUCTO_TEXT.ACTUALIZAR' | translate) : ('PRODUCTO_TEXT.CREAR' | translate) }}
    </button>
  </form>
</div>
